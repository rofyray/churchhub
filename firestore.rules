rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper to check if user is admin of this church
    function isChurchAdmin(churchId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.churchId == churchId;
    }

    // Helper to validate a registration token
    function isValidToken(churchId, tokenId) {
      let tokenPath = /databases/$(database)/documents/churches/$(churchId)/registrationTokens/$(tokenId);
      let tokenData = get(tokenPath).data;
      return exists(tokenPath) &&
        tokenData.isActive == true &&
        tokenData.expiresAt > request.time;
    }

    // Admins collection (top-level)
    match /admins/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow create, update, delete: if false; // Only via Admin SDK or Firebase Console
    }

    // Churches and all subcollections
    match /churches/{churchId} {
      allow read, write: if isChurchAdmin(churchId);

      // Departments - allow public read for join form dropdown
      match /departments/{deptId} {
        allow read: if true;
        allow write: if isChurchAdmin(churchId);
      }

      // Members
      match /members/{memberId} {
        allow read, write: if isChurchAdmin(churchId);
      }

      // Attendance
      match /attendance/{recordId} {
        allow read, write: if isChurchAdmin(churchId);
      }

      // Welfare
      match /welfare/{welfareId} {
        allow read, write: if isChurchAdmin(churchId);
      }

      // Registration Tokens
      match /registrationTokens/{tokenId} {
        allow read, write: if isChurchAdmin(churchId);
        allow get: if true; // Public can read single token for validation
      }

      // Pending Members
      match /pendingMembers/{pendingId} {
        allow read, write: if isChurchAdmin(churchId);
        // Public can create if they have a valid token
        allow create: if request.resource.data.tokenId != null &&
          isValidToken(churchId, request.resource.data.tokenId) &&
          request.resource.data.status == 'pending';
      }
    }
  }
}
